<!DOCTYPE html>
<html>
<head>
    <title>Restaurant Menu</title>
  <link rel="stylesheet" href="customer.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  

  <header class="app-header">
  <div class="header-left">
    <span id="table-indicator">Table 3</span>
  </div>
  
  <div class="header-main">
    <h1 id="restaurant"></h1>
    <p id="status">Loading...</p>
  </div>
<div class="header-right">
  <button id="orders-btn">ðŸ§¾ Orders</button>
</div>
</header>


  <div id="staff-indicator"></div>   <!-- âœ… HERE -->

  <div class="layout">
  <div id="categories"></div>
  <div id="menu"></div>
  </div>
  
  <!-- ORDER DRAWER -->
<div id="orders-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-content" id="orders-drawer-content"></div>
</div>


<!-- ITEM DRAWER OVERLAY -->
<div id="drawer-overlay"></div>

<!-- ITEM DRAWER -->
<div id="item-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-content"></div>
</div>

<!-- CART DRAWER -->
<div id="cart-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-content" id="cart-drawer-content"></div>
</div>

<!-- CART BAR -->
<div id="cart-bar">
  <div class="cart-info">
    <span id="cart-count">0 items</span>
    <strong id="cart-total">$0.00</strong>
  </div>
  <button id="confirm-order-btn" disabled>Confirm</button>
</div>





  <script>
  //Swipe
  let touchStartY = 0;
  let touchCurrentY = 0;
  let mouseStartY = 0;
  let mouseCurrentY = 0;
  let dragging = false;
  let activeDrawer = null;

    const API_BASE = "https://chuio.io/api";
    const urlParams = new URLSearchParams(window.location.search);
    const IS_STAFF = urlParams.get("staff") === "1";


if (IS_STAFF) {
  document.getElementById("staff-indicator").textContent =
    "ðŸ‘¨â€ðŸ³ Staff Ordering Mode";
}

const pathParts = window.location.pathname
  .split("/")
  .filter(Boolean);

const qrToken = window.location.pathname
  .split("/")
  .filter(Boolean)[0];

console.log("QR TOKEN:", qrToken);



    let sessionId = null;
    let restaurantId = null;
    let tableName = null;
      // ðŸ›’ NEW: Cart state
    let cart = {
      items: [],
      total: 0
    };

    // ðŸ”¥ Variant selection state (REQUIRED)
    const variantSelections = {};


    async function init() {

      if (!qrToken) {
  alert("Invalid QR code");
  return;
}

      // Scan QR
      const sessionRes = await fetch(
        `${API_BASE}/scan/${qrToken}`,{
             method: "POST"
        }
      );

const session = await sessionRes.json();

if (!session.restaurant_id) {
  alert("Session error: no restaurant");
  return;
}

sessionId = session.session_id;
restaurantId = session.restaurant_id;
tableName = session.table_id;

    // UI
    document.getElementById("table-indicator").textContent = `Table ${tableName}`;
    document.getElementById("status").textContent = "";
    document.getElementById("restaurant").textContent = "My Restaurant";
    document.getElementById("confirm-order-btn").addEventListener("click", submitOrder);
    document.getElementById("drawer-overlay").addEventListener("click", closeAllDrawers);
    document.getElementById("orders-btn").addEventListener("click", openOrdersDrawer);

     console.log(sessionId, restaurantId, tableName) //debug

      // Load menu
      const menuRes = await fetch(
  `${API_BASE}/restaurants/${restaurantId}/menu`
);

      window.menu = await menuRes.json();
        renderMenu(menu);
        renderCategories(menu.categories);
          initDrawerSwipe();
          initOrdersDrawerSwipe();
          startOrderPolling();
          initCategoryObserver(menu.categories);

    
          // Enable cart bar click â†’ open cart drawer
    document.getElementById('cart-bar').addEventListener('click', () => {
      if (!cart || !cart.items || cart.items.length === 0) return;
      
document.getElementById("item-drawer").addEventListener("click", e => {
  e.stopPropagation();
});

document.getElementById("cart-drawer").addEventListener("click", e => {
  e.stopPropagation();
});

      openCartDrawer();
    });

document
  .getElementById("drawer-overlay")
  .addEventListener("click", closeAllDrawers);


document.getElementById("orders-drawer").addEventListener("click", e => {
  e.stopPropagation();
});

    
  updateCartBar();

    }


function renderCategories(categories) {
  const catDiv = document.getElementById("categories");
  const menu = document.getElementById("menu");

  catDiv.innerHTML = "";

  categories.forEach(cat => {
    const el = document.createElement("div");
    el.className = "category-item";
    el.textContent = cat.name;
    el.dataset.categoryId = cat.id;

    el.onclick = () => {
      const target = document.getElementById(`category-${cat.id}`);
      if (!target) return;

      const menuRect = menu.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      const headerHeight =
        document.querySelector(".app-header")?.offsetHeight || 0;

      const offset =
        targetRect.top - menuRect.top + menu.scrollTop - headerHeight;

      menu.scrollTo({
        top: offset,
        behavior: "smooth"
      });

      setActiveCategory(cat.id);
    };

    catDiv.appendChild(el);
  });
}

//RenderMenu to put food cards inside grid 
function renderMenu(menu) {
  const container = document.getElementById("menu");
  container.innerHTML = "";

  const { categories, items } = menu;

  categories.forEach(category => {
    // Category title
    const categoryTitle = document.createElement("div");
    categoryTitle.className = "category";
    categoryTitle.id = `category-${category.id}`;
    categoryTitle.textContent = category.name;
    
    container.appendChild(categoryTitle);

    // Grid for items
    const grid = document.createElement("div");
    grid.className = "menu-grid";

    const categoryItems = items.filter(
      item => item.category_id === category.id
    );  
    console.log(menu);

    categoryItems.forEach(item => {
      const itemEl = renderMenuItem(item);
      grid.appendChild(itemEl);
    });

    container.appendChild(grid);
  });
}

//Clicking an item navigates to detail paige
function renderMenuItem(item) {
  const card = document.createElement("div");
  card.className = "menu-item";

 card.innerHTML = `
  <img src="${item.image_url || "https://via.placeholder.com/300"}" />

  <div class="menu-item-name">${item.name}</div>

  <div class="menu-item-footer">
    <span class="menu-item-price">
      $${(item.price_cents / 100).toFixed(2)}
    </span>
    <span class="menu-item-arrow">â€º</span>
  </div>
`;

  card.onclick = () => openDrawer(item.id);




  return card;



}//Render

function renderMenuItemWithVariants(item){
    const card = document.createElement("div");
    card.className = "drawer-item";

    card.innerHTML = `
    <img src="${item.image_url || "https://via.placeholder.com/300"}"/>

    <div class="menu-item-content">
      <div class="menu-item-name">${item.name}</div>
      <div class="menu-item-price">
        $${(item.price_cents / 100).toFixed(2)}
      </div>
      ${item.description ? `<div class="menu-item-desc">${item.description}</div>` : ""}
    </div>
  `;

  const content = card.querySelector(".menu-item-content");

    // Add variants
    if (Array.isArray(item.variants)) {
  item.variants.forEach(v => {
        const vContainer = document.createElement("div");
        vContainer.className = "variant-group";

        vContainer.innerHTML = `
          <div class="variant-title">
            <strong>
              ${v.name}
              ${v.required ? `<span style="color:red;"> *</span>` : ""}
            </strong>
            <small id="variant-counter-${item.id}-${v.id}" style="margin-left:6px;color:#666;">
              ${
                v.min_select === v.max_select && v.min_select !== null
                  ? `(select ${v.min_select})`
                  : v.max_select
                  ? `(select ${v.min_select ?? 0}â€“${v.max_select})`
                  : v.min_select
                  ? `(select at least ${v.min_select})`
                  : `(optional)`
              }
            </small>
          </div>
        `;



        (v.options || [])
        .filter(o => o.is_available)
        .forEach(o => {
        const opt = document.createElement("label");

        opt.innerHTML = `
          <input
            type="checkbox"
            value="${o.id}"
            data-item-id="${item.id}"
            data-variant-id="${v.id}"
             ${
    variantSelections[item.id]?.[v.id]?.includes(o.id)
      ? "checked"
      : ""}
            onchange="onVariantChange(${item.id}, ${v.id}, ${o.id}, this.checked)"
          />
          <span>
          ${o.name}
          ${o.price_cents > 0 ? `(+$${(o.price_cents / 100).toFixed(2)})` : ""}
          </span>
        `;
      

        vContainer.appendChild(opt);       
         vContainer.appendChild(document.createElement("br"));

      });

content.appendChild(vContainer);
    });
  }

 // ---------- ADD TO CART BUTTON ----------
  const addBtn = document.createElement("button");
  addBtn.className = "add-btn";
  addBtn.textContent = "Add to Cart";
  addBtn.dataset.itemId = item.id;
  addBtn.disabled = !canAddToCart(item);
  addBtn.onclick = () => addToCart(item);

  content.appendChild(addBtn);

  return card;


}

function setActiveCategory(categoryId) {
  document.querySelectorAll(".category-item").forEach(el => {
    el.classList.remove("active");
  });

  const active = document.querySelector(
    `.category-item[data-category-id="${categoryId}"]`
  );

  if (active) active.classList.add("active");
}

function initCategoryObserver(categories) {
  const observer = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id.replace("category-", "");
          setActiveCategory(id);
        }
      });
    },
    { rootMargin: "-40% 0px -55% 0px" }
  );

  categories.forEach(cat => {
    const el = document.getElementById(`category-${cat.id}`);
    if (el) observer.observe(el);
  });
}


function addToCart(item) {
  const selectedOptions = [];
  const variantDetails = [];
  let extraPrice = 0;

  item.variants.forEach(v => {
  const selectedIds = variantSelections[item.id]?.[v.id] || [];

 if (v.required && selectedIds.length === 0) {
  alert(`Please select ${v.name}`);
  throw new Error("Missing required variant");
}

if (v.max_select && selectedIds.length > v.max_select) {
  alert(`You can only select ${v.max_select} for ${v.name}`);
  throw new Error("Too many selections");
}

  selectedIds.forEach(optionId => {
    const option = v.options.find(o => o.id === optionId);

    selectedOptions.push(optionId);
    variantDetails.push({
      variant: v.name,
      option: option.name
    });

    extraPrice += option.price_cents || 0;
  });
});


  const existing = cart.items.find(
    c =>
      c.menuItemId === item.id &&
      JSON.stringify(c.variantOptionIds) === JSON.stringify(selectedOptions)
  );

  if (existing) {
    existing.quantity += 1;
  } else {
    cart.items.push({
  menuItemId: item.id,
  name: item.name,
  quantity: 1,
  basePriceCents: item.price_cents,
  totalPriceCents: item.price_cents + extraPrice,
  variantOptionIds: selectedOptions,
  variantOptionDetails: variantDetails
});

  }
  closeDrawer();
  updateCartBar();

}

function canAddToCart(item) {
  if (!item.variants || item.variants.length === 0) return true;

  for (const v of item.variants) {
    const selected =
      variantSelections[item.id]?.[v.id]?.length || 0;

    const min = v.min_select ?? (v.required ? 1 : 0);

    if (selected < min) {
      return false;
    }
  }

  return true;
}

function updateAddToCartButton(item) {
  const btn = document.querySelector(
    `button[data-item-id="${item.id}"]`
  );

  if (!btn) return;

  btn.disabled = !canAddToCart(item);
}

function updateVariantCounter(itemId, variant) {
  const selected =
    variantSelections[itemId]?.[variant.id] || [];

  const count = selected.length;

  const counterEl = document.getElementById(
    `variant-counter-${itemId}-${variant.id}`
  );

  if (counterEl) {
    if (variant.max_select) {
      counterEl.textContent = `${count} / ${variant.max_select} selected`;
    } else {
      counterEl.textContent = `${count} selected`;
    }
  }

  // ðŸ”¥ THIS IS THE MISSING PART ðŸ”¥
  const inputs = document.querySelectorAll(
    `input[data-item-id="${itemId}"][data-variant-id="${variant.id}"]`
  );

  // 1ï¸âƒ£ ALWAYS reset disabled state first
  inputs.forEach(input => {
    input.removeAttribute("disabled");
    input.disabled = false;
  });

  // 2ï¸âƒ£ Apply max_select rule ONLY if max reached
  if (variant.max_select && count >= variant.max_select) {
    inputs.forEach(input => {
      const optionId = Number(input.value);
      if (!selected.includes(optionId)) {
        input.disabled = true;
      }
    });
  }
}

async function submitOrder() {
  if (!cart.items.length) return;

  const payload = {
    items: cart.items.map(i => ({
      menu_item_id: i.menuItemId,
      quantity: i.quantity,
      selected_option_ids: i.variantOptionIds || []
    }))
  };

  const res = await fetch(
    `${API_BASE}/sessions/${sessionId}/orders`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }
  );

  if (!res.ok) {
    const err = await res.json();
    alert(err.error || "Order failed");
    return;
  }

    cart.items = [];
    updateCartBar();
    closeCartDrawer();

    alert("Order sent to kitchen!");

}

function onVariantChange(itemId, variantId, optionId, checked) {
  if (!variantSelections[itemId]) {
    variantSelections[itemId] = {};
  }

  const item = window.menu.items.find(i => i.id === itemId);
  const variant = item.variants.find(v => v.id === variantId);

  let selected = variantSelections[itemId][variantId] || [];

  // ------------------------------
  // EXACT MODE (min === max)
  // ------------------------------
  if (
    variant.min_select !== null &&
    variant.max_select !== null &&
    variant.min_select === variant.max_select
  ) {
    if (checked) {
      selected = [optionId];

      // force UI sync
      document
        .querySelectorAll(
          `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
        )
        .forEach(input => {
          input.checked = Number(input.value) === optionId;
        });
    } else {
      // prevent unchecking below min
      selected = [];
    }
  }

  // ------------------------------
  // NORMAL MULTI MODE
  // ------------------------------
  else {
    if (checked) {
      if (variant.max_select && selected.length >= variant.max_select) {
        // undo UI change
        const input = document.querySelector(
          `input[data-item-id="${itemId}"][data-variant-id="${variantId}"][value="${optionId}"]`
        );
        if (input) input.checked = false;
        return;
      }
      selected.push(optionId);
    } else {
      selected = selected.filter(id => id !== optionId);
    }
  }

  variantSelections[itemId][variantId] = selected;

  // ------------------------------
  // Disable unchecked when max reached
  // ------------------------------
if (variant.max_select) {
  document
    .querySelectorAll(
      `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
    )
    .forEach(input => {
      const id = Number(input.value);

    });
}


  updateVariantCounter(itemId, variant);
  updateAddToCartButton(item);
}

async function loadOrderStatus() {
  if (!sessionId) return;

  const res = await fetch(
    `${API_BASE}/sessions/${sessionId}/orders`
  );

  if (!res.ok) return;

  const data = await res.json();
  renderOrdersDrawer(data.items || []);
}

function renderOrdersDrawer(orders) {
  const el = document.getElementById("orders-drawer-content");
  if (!el) return;

  let total = 0;

  if (!orders.length) {
    el.innerHTML = "<p>No orders yet</p>";
    return;
  }

  el.innerHTML = orders.flatMap(order =>
    order.items.map(item => {
      const line = item.total_price_cents;
      total += line;

      return `
        <div class="order-item">
          <strong>${item.name}</strong> Ã— ${item.quantity}<br/>
          ${item.variants || ""}
          <br/>
          <strong class="status-${item.status}">(${item.status})</strong>
<br/>
          $${(line / 100).toFixed(2)}
        </div>
      `;
    })
  ).join("");

  el.innerHTML += `
    <hr/>
    <strong>Total: $${(total / 100).toFixed(2)}</strong>
  `;
}

function renderCartDrawer() {
  const el = document.getElementById("cart-drawer-content");

  if (!cart.items.length) {
    el.innerHTML = "<p>Your cart is empty</p>";
    return;
  }

  let total = 0;

  el.innerHTML = cart.items.map((item, idx) => {
    const line =
      item.totalPriceCents * item.quantity;
    total += line;

    return `
      <div class="cart-item">
        <strong>${item.name}</strong><br/>
        ${item.variantOptionDetails?.map(v => `${v.variant}: ${v.option}`).join(", ") || ""}
        <div class="qty-controls">
          <button onclick="updateCartQty(${idx}, -1)">âˆ’</button>
          <span>${item.quantity}</span>
          <button onclick="updateCartQty(${idx}, 1)">+</button>
          <button onclick="removeCartItem(${idx})">ðŸ—‘</button>
        </div>
        $${(line / 100).toFixed(2)}
      </div>
    `;
  }).join("");

  el.innerHTML += `
    <hr/>
    <strong>Total: $${(total / 100).toFixed(2)}</strong>
  `;
}

function updateCartQty(index, delta) {
  const item = cart.items[index];
  if (!item) return;

  item.quantity += delta;

  if (item.quantity <= 0) {
    cart.items.splice(index, 1);
  }

  updateCartBar();
  renderCartDrawer();
}

function removeCartItem(index) {
  cart.items.splice(index, 1);
  updateCartBar();
  renderCartDrawer();
}

function openCartDrawer() {
    closeAllDrawers();

  activeDrawer = document.getElementById("cart-drawer");
  const overlay = document.getElementById("drawer-overlay");

  activeDrawer.classList.add("open");
  overlay.classList.add("open");
  document.body.style.overflow = "hidden";

  renderCartDrawer();
}

function updateCartBar() {
  const btn = document.getElementById("confirm-order-btn");
  const countEl = document.getElementById("cart-count");
  const totalEl = document.getElementById("cart-total");

  const count = cart.items.reduce((s, i) => s + i.quantity, 0);
  const totalCents = cart.items.reduce(
    (sum, i) => sum + i.totalPriceCents * i.quantity,
    0
  );

  countEl.textContent = `${count} item${count !== 1 ? "s" : ""}`;
  totalEl.textContent = `$${(totalCents / 100).toFixed(2)}`;

  btn.disabled = count === 0;
}

function closeDrawer() {
  const drawer = document.getElementById("item-drawer");
  const overlay = document.getElementById("drawer-overlay");
  const content = drawer.querySelector(".drawer-content");

  drawer.classList.remove("open");
  overlay.classList.remove("open");
  document.body.style.overflow = "";

  drawer.style.transform = "";
  if (content) content.scrollTop = 0;
}

function closeCartDrawer() {
  const drawer = document.getElementById("cart-drawer");
  const overlay = document.getElementById("drawer-overlay");

  drawer.classList.remove("open");
  overlay.classList.remove("open");
  document.body.style.overflow = "";
}

function openDrawer(itemId) {

    closeAllDrawers();
  

  const item = window.menu.items.find(i => i.id === itemId);
  if (!item) return;

  activeDrawer = document.getElementById("item-drawer");
   const overlay = document.getElementById("drawer-overlay");
  const content = activeDrawer.querySelector(".drawer-content");

  content.innerHTML = ""; // FULL RESET

  const itemUI = renderMenuItemWithVariants(item);
  itemUI.classList.add("drawer-item"); // important
  content.appendChild(itemUI);

  overlay.classList.add("open");
  activeDrawer.classList.add("open");

  document.body.style.overflow = "hidden";

  content.scrollTop = 0;
}

function initDrawerSwipe() {
  const drawer = document.getElementById("item-drawer");
  if (!drawer || drawer.dataset.swipeInit) return;

  drawer.dataset.swipeInit = "true";

  if (isTouchDevice()) {
    initTouchSwipe(drawer);
  } else {
    initMouseSwipe(drawer);
  }
}

function openOrdersDrawer() {
  closeAllDrawers();

  activeDrawer = document.getElementById("orders-drawer");
  const overlay = document.getElementById("drawer-overlay");

  activeDrawer.classList.add("open");
  overlay.classList.add("open");
  document.body.style.overflow = "hidden";

  // ðŸ”¥ render immediately using latest polled data
  loadOrderStatus();
}

function closeOrdersDrawer() {
  const drawer = document.getElementById("orders-drawer");
  const overlay = document.getElementById("drawer-overlay");

  drawer.classList.remove("open");
  overlay.classList.remove("open");
  document.body.style.overflow = "";
}

function initOrdersDrawerSwipe() {
  const drawer = document.getElementById("orders-drawer");
  if (!drawer || drawer.dataset.swipeInit) return;

  drawer.dataset.swipeInit = "true";

  if (isTouchDevice()) {
    initTouchSwipe(drawer);
  } else {
    initMouseSwipe(drawer);
  }
}

function isInteractiveElement(el) {
  return (
    el.tagName === "INPUT" ||
    el.tagName === "LABEL" ||
    el.tagName === "BUTTON" ||
    el.closest(".variant-group")
  );
}

function isTouchDevice() {
  return (
    "ontouchstart" in window ||
    navigator.maxTouchPoints > 0
  );
}

function initTouchSwipe(drawer) {
  drawer.addEventListener("touchstart", e => {
    if (drawer !== activeDrawer) return;
    if (isInteractiveElement(e.target)) return;

    touchStartY = e.touches[0].clientY;
    drawer.style.transition = "none";
  }, { passive: true });

  drawer.addEventListener("touchmove", e => {
    if (drawer !== activeDrawer) return;
    if (isInteractiveElement(e.target)) return;

    touchCurrentY = e.touches[0].clientY;
    const delta = touchCurrentY - touchStartY;
    if (delta < 0) return;

    drawer.style.transform = `translateY(${delta}px)`;
    e.preventDefault();
  }, { passive: false });

  drawer.addEventListener("touchend", () => {
    if (drawer !== activeDrawer) return;

    const delta = touchCurrentY - touchStartY;
    drawer.style.transition = "transform 0.25s ease";

    if (delta > 120) {
      closeActiveDrawer();
    } else {
      drawer.style.transform = "translateY(0)";
    }
  });
}

function initMouseSwipe(drawer) {
  drawer.addEventListener("mousedown", e => {
    if (drawer !== activeDrawer) return;

    dragging = true;
    mouseStartY = e.clientY;
    drawer.style.transition = "none";
  });

  window.addEventListener("mousemove", e => {
    if (!dragging || drawer !== activeDrawer) return;

    mouseCurrentY = e.clientY;
    const delta = mouseCurrentY - mouseStartY;
    if (delta < 0) return;

    drawer.style.transform = `translateY(${delta}px)`;
  });

  window.addEventListener("mouseup", () => {
    if (!dragging || drawer !== activeDrawer) return;

    dragging = false;
    const delta = mouseCurrentY - mouseStartY;

    drawer.style.transition = "transform 0.25s ease";

    if (delta > 120) {
      closeActiveDrawer();
    } else {
      drawer.style.transform = "translateY(0)";
    }
  });
}

function closeAllDrawers() {
  ["item-drawer", "orders-drawer", "cart-drawer"].forEach(id => {
    const d = document.getElementById(id);
    if (!d) return;
    d.classList.remove("open");
    d.style.transform = "";
  });

  document.getElementById("drawer-overlay")?.classList.remove("open");
  document.body.style.overflow = "";
  activeDrawer = null;
}

function closeActiveDrawer() {
  if (!activeDrawer) return;

  activeDrawer.classList.remove("open");
  activeDrawer.style.transform = "";

  document.getElementById("drawer-overlay")?.classList.remove("open");
  document.body.style.overflow = "";

  activeDrawer = null;
}


    init();
    
    let orderPollerStarted = false;

function startOrderPolling() {
  if (orderPollerStarted) return;
  orderPollerStarted = true;

  loadOrderStatus(); // immediate
  setInterval(loadOrderStatus, 5000);
}

  </script>

</body>
</html>
