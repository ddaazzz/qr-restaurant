<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="/uploads/chuio/favicon%20(1).ico">
  <title>Kitchen Dashboard | Chuio</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #f97316;
      --secondary-color: #ea6317;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --bg-dark: #111827;
      --bg-light: #f9fafb;
      --bg-white: #ffffff;
      --border-color: #e5e7eb;
      --success-color: #059669;
      --warning-color: #f59e0b;
      --pending-color: #ef4444;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      overflow: hidden;
    }

    /* ============== LOGIN SCREEN ============== */
    .login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-container {
      background: var(--bg-white);
      border-radius: 16px;
      padding: 48px 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .login-header {
      margin-bottom: 40px;
    }

    .login-header img {
      height: 80px;
      margin-bottom: 16px;
    }

    .login-header h1 {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .login-header p {
      color: var(--text-light);
      font-size: 14px;
    }

    .pin-dots {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 32px;
    }

    .pin-dots span {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border-color);
      transition: background 0.2s;
    }

    .pin-dots span.filled {
      background: var(--primary-color);
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .keypad button {
      padding: 16px;
      border: 2px solid var(--border-color);
      background: var(--bg-white);
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .keypad button:hover {
      border-color: var(--primary-color);
      background: var(--bg-light);
    }

    .keypad button.clear,
    .keypad button.enter {
      background: var(--primary-color);
      color: var(--bg-white);
      border-color: var(--primary-color);
    }

    .keypad button.clear:hover,
    .keypad button.enter:hover {
      background: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .error-message {
      color: var(--pending-color);
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }

    /* ============== KITCHEN DASHBOARD ============== */
    .kitchen-app {
      display: none;
      height: 100%;
      flex-direction: column;
    }

    .kitchen-app.active {
      display: flex;
    }

    .kitchen-header {
      background: var(--bg-white);
      padding: 20px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .kitchen-header h1 {
      font-size: 28px;
      color: var(--primary-color);
      margin: 0;
    }

    .logout-btn {
      padding: 10px 20px;
      background: var(--pending-color);
      color: var(--bg-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    .kitchen-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: var(--bg-dark);
    }

    .orders-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
      max-width: 2000px;
    }

    .no-orders {
      grid-column: 1 / -1;
      text-align: center;
      color: var(--text-light);
      padding: 60px 20px;
      font-size: 18px;
    }

    /* ============== ORDER CARD ============== */
    .order-card {
      background: var(--bg-white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .order-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .order-card.pending {
      border-left: 6px solid var(--pending-color);
    }

    .order-card.preparing {
      border-left: 6px solid var(--warning-color);
    }

    .order-card.ready {
      border-left: 6px solid var(--success-color);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--bg-white);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
    }

    .card-time {
      font-size: 12px;
      opacity: 0.9;
    }

    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .order-item {
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .order-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .item-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .item-qty {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
      min-width: 30px;
      text-align: right;
    }

    .item-variants {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 6px;
      padding: 8px;
      background: var(--bg-light);
      border-radius: 4px;
    }

    .item-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }

    .item-status.pending {
      background: rgba(239, 68, 68, 0.1);
      color: var(--pending-color);
    }

    .item-status.preparing {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
    }

    .item-status.served {
      background: rgba(5, 150, 105, 0.1);
      color: var(--success-color);
    }

    .card-actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .btn-action {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-start {
      background: var(--warning-color);
      color: var(--bg-white);
    }

    .btn-start:hover {
      background: #d97706;
      transform: translateY(-2px);
    }

    .btn-serve {
      background: var(--success-color);
      color: var(--bg-white);
    }

    .btn-serve:hover {
      background: #047857;
      transform: translateY(-2px);
    }

    .btn-ready {
      background: var(--bg-light);
      color: var(--text-dark);
      cursor: default;
    }

    /* ============== RESPONSIVE ============== */
    @media (max-width: 768px) {
      .orders-container {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .kitchen-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .kitchen-header h1 {
        font-size: 24px;
      }

      .card-body {
        padding: 16px;
      }

      .keypad button {
        padding: 14px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

  <!-- ================= LOGIN SCREEN ================= -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <img src="/uploads/chuio/chuio_logo.png" alt="Chuio Logo" />
        <h1>Kitchen Dashboard</h1>
        <p>Enter PIN to continue</p>
      </div>

      <div id="pin-login">
        <div id="pin-dots" class="pin-dots">
          <span></span><span></span><span></span><span></span><span></span><span></span>
        </div>

        <div class="keypad">
          <button onclick="pressKey(1)">1</button>
          <button onclick="pressKey(2)">2</button>
          <button onclick="pressKey(3)">3</button>

          <button onclick="pressKey(4)">4</button>
          <button onclick="pressKey(5)">5</button>
          <button onclick="pressKey(6)">6</button>

          <button onclick="pressKey(7)">7</button>
          <button onclick="pressKey(8)">8</button>
          <button onclick="pressKey(9)">9</button>

          <button class="clear" onclick="clearPin()">‚å´</button>
          <button onclick="pressKey(0)">0</button>
          <button class="enter" onclick="submitPin()">‚èé</button>
        </div>

        <div id="error-message" class="error-message"></div>
      </div>
    </div>
  </div>

  <!-- ================= KITCHEN APP ================= -->
  <div id="kitchen-app" class="kitchen-app">
    <div class="kitchen-header">
      <h1>üç≥ Kitchen Dashboard</h1>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <div class="kitchen-content">
      <div id="orders-container" class="orders-container">
        <p class="no-orders">Loading orders...</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 
      window.location.hostname === "localhost"
        ? "http://localhost:10000/api"
        : "https://chuio.io/api";

    let pin = "";
    let token = null;
    let restaurantId = null;

    // ============== PIN LOGIN ============== 
    function pressKey(num) {
      if (pin.length < 6) {
        pin += num;
        updatePinDisplay();
      }
    }

    function clearPin() {
      pin = "";
      updatePinDisplay();
    }

    function updatePinDisplay() {
      const dots = document.querySelectorAll("#pin-dots span");
      dots.forEach((dot, idx) => {
        dot.classList.toggle("filled", idx < pin.length);
      });
    }

    async function submitPin() {
      if (pin.length !== 6) return;

      const errorEl = document.getElementById("error-message");
      errorEl.style.display = "none";

      try {
        // Get restaurantId from URL params
        const params = new URLSearchParams(window.location.search);
        restaurantId = params.get("restaurantId");

        if (!restaurantId) {
          errorEl.textContent = "Restaurant ID required";
          errorEl.style.display = "block";
          return;
        }

        const res = await fetch(`${API_BASE}/auth/staff-login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pin, restaurantId })
        });

        const data = await res.json();

        if (!res.ok || !data.token) {
          errorEl.textContent = data.error || "Invalid PIN";
          errorEl.style.display = "block";
          pin = "";
          updatePinDisplay();
          return;
        }

        // Check if user is kitchen staff
        if (data.role !== "kitchen") {
          errorEl.textContent = "Access denied. Kitchen staff only.";
          errorEl.style.display = "block";
          pin = "";
          updatePinDisplay();
          return;
        }

        token = data.token;
        sessionStorage.setItem("kitchenToken", token);
        sessionStorage.setItem("restaurantId", restaurantId);

        // Show kitchen dashboard
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("kitchen-app").classList.add("active");

        // Start loading orders
        loadKitchenOrders();
        setInterval(loadKitchenOrders, 5000);
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Connection error";
        errorEl.style.display = "block";
      }
    }

    // ============== KITCHEN DASHBOARD ============== 
    async function loadKitchenOrders() {
      if (!restaurantId) return;

      try {
        const res = await fetch(`${API_BASE}/kitchen/items`);
        if (!res.ok) return;

        const items = await res.json();

        // Filter items for this restaurant and group by order
        const orderMap = {};

        items.forEach(item => {
          if (item.restaurant_id != restaurantId) return;

          const orderId = item.order_id;
          if (!orderMap[orderId]) {
            orderMap[orderId] = {
              orderId,
              table: item.table_name,
              items: [],
              createdAt: item.created_at
            };
          }
          orderMap[orderId].items.push(item);
        });

        renderKitchenOrders(Object.values(orderMap));
      } catch (err) {
        console.error("Failed to load kitchen items:", err);
      }
    }

    function renderKitchenOrders(orders) {
      const container = document.getElementById("orders-container");

      if (!orders.length) {
        container.innerHTML = '<p class="no-orders">‚úì All orders completed!</p>';
        return;
      }

      container.innerHTML = orders.map(order => {
        const hasAllServed = order.items.every(item => item.status === "served");
        const statusClass = hasAllServed ? "ready" : (order.items.some(item => item.status === "preparing") ? "preparing" : "pending");

        return `
          <div class="order-card ${statusClass}">
            <div class="card-header">
              <div>
                <div class="card-title">Table ${order.table}</div>
                <div class="card-time">#${order.orderId}</div>
              </div>
              <div class="card-time">${getTimeAgo(order.createdAt)}</div>
            </div>
            <div class="card-body">
              ${order.items.map(item => `
                <div class="order-item">
                  <div class="item-header">
                    <span class="item-name">${item.item_name}</span>
                    <span class="item-qty">√ó${item.quantity}</span>
                  </div>
                  ${item.variants ? `<div class="item-variants">${item.variants}</div>` : ""}
                  <span class="item-status ${item.status}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
                </div>
              `).join("")}
              
              <div class="card-actions">
                ${order.items.map(item => {
                  if (item.status === "pending") {
                    return `<button class="btn-action btn-start" onclick="updateItemStatus(${item.order_item_id}, 'preparing')">Start Preparing</button>`;
                  } else if (item.status === "preparing") {
                    return `<button class="btn-action btn-serve" onclick="updateItemStatus(${item.order_item_id}, 'served')">Serve</button>`;
                  } else {
                    return `<button class="btn-action btn-ready" disabled>Served</button>`;
                  }
                }).join("")}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function updateItemStatus(orderItemId, status) {
      try {
        const res = await fetch(`${API_BASE}/order-items/${orderItemId}/status`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });

        if (res.ok) {
          loadKitchenOrders();
        }
      } catch (err) {
        console.error("Failed to update item status:", err);
      }
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const then = new Date(timestamp);
      const diff = Math.floor((now - then) / 1000);

      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      return `${Math.floor(diff / 3600)}h ago`;
    }

    function handleLogout() {
      sessionStorage.removeItem("kitchenToken");
      sessionStorage.removeItem("restaurantId");
      pin = "";
      token = null;
      restaurantId = null;
      updatePinDisplay();
      document.getElementById("login-screen").style.display = "flex";
      document.getElementById("kitchen-app").classList.remove("active");
    }

    // ============== INIT ============== 
    window.addEventListener("DOMContentLoaded", () => {
      // Check if already logged in
      const savedToken = sessionStorage.getItem("kitchenToken");
      const savedRestaurantId = sessionStorage.getItem("restaurantId");

      if (savedToken && savedRestaurantId) {
        token = savedToken;
        restaurantId = savedRestaurantId;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("kitchen-app").classList.add("active");
        loadKitchenOrders();
        setInterval(loadKitchenOrders, 5000);
      }
    });
  </script>

</body>
</html>

