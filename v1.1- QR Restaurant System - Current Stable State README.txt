# QR Restaurant System — Current Stable State (README)

This document describes the **current working and stable version** of the QR Restaurant system.
It is intended to be used as a **handover reference** for continuing development in a new ChatGPT conversation.

---

## 1. System Overview

This project is a **QR-code based restaurant ordering system** with:

* Customer-facing menu & ordering via QR code
* Staff dashboard for table/session/order management
* Kitchen view for active orders
* Backend API built with **Node.js + Express + TypeScript**
* Database using **PostgreSQL**

⚠️ **Important scope note**:

* There are **NO food variants, add-ons, or combo/set logic** in this version
* Food items are simple single items with price and availability

---

## 2. Folder Structure

```
qr-restaurant/
├── backend/
│   ├── src/
│   │   ├── config/
│   │   │   └── db.ts
│   │   ├── routes/
│   │   │   ├── menu.routes.ts
│   │   │   ├── orders.routes.ts
│   │   │   ├── restaurants.routes.ts
│   │   │   ├── scan.routes.ts
│   │   │   ├── sessions.routes.ts
│   │   │   ├── staff.routes.ts
│   │   │   └── tables.routes.ts
│   │   ├── app.ts
│   │   └── server.ts
│   ├── scripts/
│   ├── tsconfig.json
│   └── README.txt
│
├── frontend/
│   ├── index.html
│   ├── kitchen.html
│   ├── staff.html
│   └── staff.js
│
└── README.md (this file)
```

---

## 3. Backend Architecture

### 3.1 Tech Stack

* Node.js
* Express
* TypeScript
* PostgreSQL
* `pg` for database access

---

### 3.2 Database Tables (PostgreSQL)

Only the following tables exist and are used:

### restaurants

```sql
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
```

---

### tables

```sql
id SERIAL PRIMARY KEY,
restaurant_id INTEGER REFERENCES restaurants(id) ON DELETE CASCADE,
name TEXT NOT NULL,
created_at TIMESTAMP DEFAULT NOW()
```

Represents physical tables in a restaurant.

---

### table_sessions

```sql
id SERIAL PRIMARY KEY
table_id INT REFERENCES tables(id)
restaurant_id INT REFERENCES restaurants(id)
active BOOLEAN
started_at TIMESTAMP
ended_at TIMESTAMP
```

* A table can have **only one active session** at a time
* Sessions are started and ended by **staff only**

---

### menu_categories

```sql
id SERIAL PRIMARY KEY,
restaurant_id INTEGER NOT NULL
REFERENCES restaurants(id) ON DELETE CASCADE,
name TEXT NOT NULL,
sort_order INTEGER DEFAULT 0
```

---

### menu_items

```sql
id SERIAL PRIMARY KEY,
category_id INTEGER NOT NULL
REFERENCES menu_categories(id) ON DELETE CASCADE,
name TEXT NOT NULL,
price_cents INTEGER NOT NULL,
description TEXT,
available BOOLEAN DEFAULT TRUE
image_url TEXT
```

* `image_url` is supported
* No variants or add-ons

---

### orders

```sql
id SERIAL PRIMARY KEY
session_id INT REFERENCES table_sessions(id)
status TEXT DEFAULT 'pending',
created_at TIMESTAMP DEFAULT NOW()
```

---

### order_items

```sql
id SERIAL PRIMARY KEY
order_id INT REFERENCES orders(id)
menu_item_id INT REFERENCES menu_items(id)
quantity INT
price_cents INT
```

* `price_cents` is stored per item at time of order

---

## 4. Backend Routes

### menu.routes.ts

Defines all menu-related Express routes for the QR Restaurant backend using PostgreSQL (pg pool).

GET /restaurants/:restaurantId/menu
Customer menu: returns { categories, items }
- Tables: menu_categories, menu_items
- Join: menu_items.category_id → menu_categories.id
- Filters: mi.available = true
- Order: menu_categories.sort_order

GET /restaurants/:restaurantId/menu/staff
Staff menu: returns all items (available + unavailable) with category_name

PATCH /menu-items/:id/availability
Toggles menu_items.available (staff control)

PATCH /menu-items/:id/image
Updates menu_items.image_url (URL only, no upload logic)

Key Notes
- Price stored as price_cents
- Availability is boolean
- No variants/modifiers
- Categories & items returned separately
- Customer view hides unavailable items, staff view shows all

---

### orders.routes.ts
Defines all order and session-related Express routes for the QR Restaurant backend using PostgreSQL (pg pool).

POST /sessions/:sessionId/orders
- Places an order for an active table session (table_sessions.ended_at IS NULL)
- Creates orders row (status = 'pending')
- Inserts order_items with menu_item_id, quantity, price_cents
- Reads base price from menu_items.price_cents
- Inserts selected variants into order_item_variants from menu_item_variant_options
- Rejects if session is closed or item is sold out

GET /sessions/:sessionId/orders
Returns all orders for a session
- Joins: orders, order_items, menu_items, order_item_variants
- Calculates per-item unit price, total price, order total, and session total
- Prices aggregated in cents, formatted to currency in response

GET /orders
Kitchen view: returns all active (not served) orders
- Includes table name, session id, order status, created time, and item list
- Ordered by created_at ASC

PATCH /orders/:id/status
Updates order status (pending | preparing | served)

POST /sessions/:sessionId/close
Closes a table session
- Sets table_sessions.ended_at = NOW()
- Marks all session orders as served

Key Notes
- Supports item variants via order_item_variants
- All pricing uses integer cents
- Session lifecycle strictly enforced
- Kitchen flow driven by order status

---

### restaurants.routes.ts

Defines the restaurant listing route for the QR Restaurant backend using Express + PostgreSQL (pg pool).

GET /restaurants
- Returns all restaurants from the restaurants table

Key Notes
- Read-only route
- No authentication or filtering
- Used for restaurant selection / bootstrap data

---

### tables.routes.ts

Defines table management and QR token generation routes for staff using Express + PostgreSQL (pg pool).

GET /restaurants/:restaurantId/tables
Returns all tables for a restaurant (tables), ordered by id

POST /restaurants/:restaurantId/tables
- Creates a new table
- Requires name
- Generates unique qr_token using crypto.randomBytes
- Inserts into tables
- Returns table info + QR URL

POST /tables/:tableId/regenerate-qr
- Regenerates a table’s qr_token (staff only)

Key Notes
- tables.qr_token is the QR scan entry key
- QR token maps 1:1 to a table
- QR URL currently hardcoded to local host (can be env-based later)

---

### sessions.routes.ts

Defines table session management routes for staff dashboards using Express + PostgreSQL (pg pool).

GET /restaurants/:restaurantId/sessions
Staff view of all tables with current session state
- LEFT JOIN tables → table_sessions
- Only active sessions (ended_at IS NULL)
- Returns table info + session id, start/end timestamps

POST /tables/:tableId/sessions
- Starts a new table session (staff only)
- Prevents duplicate active sessions
- Inserts into table_sessions

POST /sessions/:sessionId/end
- Ends an active session
- Sets table_sessions.ended_at = NOW()
- Marks all related orders as served

Key Notes
- One active session per table
- Session lifecycle enforced via ended_at
- Staff-only control layer for tables and sessions

---

### scan.routes.ts

Defines the QR scan entry point for starting or resuming a table session using Express + PostgreSQL (pg pool).

POST /scan/:qrToken
Handles QR code scans for tables
- Looks up table via tables.qr_token
- Returns 404 if QR is invalid
- Checks for an active session in table_sessions (ended_at IS NULL)
- Creates a new session if none exists
- Reuses existing session if already active

Response
- session_id
- table_id
- restaurant_id

Key Notes
- One active session per table
- Session lifecycle controlled via ended_at
- Primary entry point for customer ordering flow

---

### staff.routes.ts

Defines staff dashboard data aggregation for active tables using Express + PostgreSQL (pg pool).

GET /restaurants/:restaurantId/active-sessions-with-orders
Returns all active table sessions for a restaurant with related orders and items

Tables joined:
- table_sessions (active only: ended_at IS NULL)
- tables
- orders
- order_items
- menu_items

Includes:
- table info (table_id, table_name)
- session id
- order id, status, created time
- item name, quantity, price_cents

Key Notes
- Single flattened result set (staff groups client-side)
- Includes sessions even if no orders yet
- Used for real-time staff / floor monitoring

---

## 5. Frontend Pages

### index.html (Customer)
Customer-facing menu and ordering page built in vanilla HTML + JS.

QR Scan Flow

- Extracts qrToken from URL
- POST /api/scan/:qrToken → creates/returns table session
- Stores sessionId + restaurantId

Menu Display

- GET /api/restaurants/:restaurantId/menu → { categories, items }
- Renders categories and available items
- “Add to Cart” button updates local cart state

Cart & Order

- Tracks cart (menuItemId, name, quantity, priceCents)
- Displays total price
- POST /api/sessions/:sessionId/orders → submits order to kitchen
- Clears cart after submission

Order Status

- Polls every 5s: GET /api/sessions/:sessionId/orders
- Displays order items, quantities, total, and last order status

Session Control
- Button triggers POST /api/sessions/:sessionId/close
- Ends session and reloads page

Key Notes
- No frameworks, pure DOM manipulation
- Prices stored in cents, converted for display
- Supports multiple items per order, quantity increment
- Handles real-time status updates via polling

---

### staff.html (Staff Dashboard)

Staff dashboard page built in vanilla HTML + JS for table, session, and menu management.
- Tables & QR Codes
- GET /restaurants/:restaurantId/tables → list all tables
- Displays QR code via qrcodejs
- Buttons to start/end sessions (POST /tables/:tableId/sessions, POST /sessions/:sessionId/end)
- Shows session status (active/inactive) and active orders per table

Active Sessions
- GET /restaurants/:restaurantId/active-sessions-with-orders
- Displays orders, item names, quantities, line totals, and order total per session
- Auto-refresh every 5s

Menu Management
- GET /restaurants/:restaurantId/menu/staff → list all items
- Shows category, price, availability (AVAILABLE/SOLD OUT)
- PATCH /menu-items/:id/availability → toggle item availability

Key Notes
- Polling every 5s to refresh tables, sessions, and menu
- Prices displayed in dollars (cents → USD)
- Flattened view for quick staff reference
- QR token maps 1:1 to table, used for customer session entry
- Staff can manage sessions, track orders, and control menu availability in real-time

---

### kitchen.html (Kitchen Dashboard)

Kitchen dashboard page built in vanilla HTML + JS for real-time order management.

Active Orders
GET /api/orders → fetch all active orders (status ≠ served)

Displays:
- Table name
- Order status (pending, preparing, served)
- Order items with quantities

Order Status Update
- pending → preparing
- preparing → served
- PATCH /api/orders/:id/status updates order status in backend

Real-Time Updates
- Orders auto-refresh every 5 seconds via polling

Key Notes
- Simple, flattened UI for kitchen staff
- Uses buttons to progress order lifecycle
- Prices are not displayed (kitchen only needs items and quantities)
- Status color-coded (orange) for visual clarity


---
## 6. Business Rules (Confirmed)

* Customers **cannot start or end sessions**
* Sessions are managed only by staff
* Orders belong to sessions, not tables directly
* Ending a session closes all ordering for that table
* Menu availability is enforced via `menu_items.available`

---

## 7. Explicitly Out of Scope (NOT IMPLEMENTED)

The following do **NOT exist** in this version:

* Food variants
* Add-ons
* Combo / set meals
* Variant pricing logic
* Variant tables in database

---

## 8. Recommended Next Steps (Future Work)

When restarting development:

1. Redesign food variants **from scratch**
2. Define variant ownership clearly (menu-level vs order-level)
3. Add schema only after API contract is finalized

---

## 9. Usage Note for New ChatGPT Session

When continuing development:

> "This README represents my current stable system. Continue from here without assuming any food variant implementation."

---

✅ **This document accurately reflects the current working state of the project.**
